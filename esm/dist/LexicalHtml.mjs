/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{$cloneWithProperties as e,$sliceSelectedTextNodeContent as n}from"@lexical/selection";import{isHTMLElement as t,isBlockDomNode as o}from"@lexical/utils";import{$getRoot as l,$isElementNode as r,$isTextNode as i,$isRootOrShadowRoot as s,$isBlockElementNode as c,ArtificialNode__DO_NOT_USE as u,$createLineBreakNode as f,$createParagraphNode as a}from"lexical";function d(e,n){const t=n.body?n.body.childNodes:[];let o=[];const l=[];for(let n=0;n<t.length;n++){const r=t[n];if(!m.has(r.nodeName)){const n=g(r,e,l,!1);null!==n&&(o=o.concat(n))}}return function(e){for(const n of e)n.getNextSibling()instanceof u&&n.insertAfter(f());for(const n of e){const e=n.getChildren();for(const t of e)n.insertBefore(t);n.remove()}}(l),o}function h(e,n){if("undefined"==typeof document||"undefined"==typeof window&&void 0===global.window)throw new Error("To use $generateHtmlFromNodes in headless mode please initialize a headless browser implementation such as JSDom before calling this function.");const t=document.createElement("div"),o=l().getChildren();for(let l=0;l<o.length;l++){p(e,o[l],t,n)}return t.innerHTML}function p(o,l,s,c=null){let u=null===c||l.isSelected(c);const f=r(l)&&l.excludeFromCopy("html");let a=l;if(null!==c){let t=e(l);t=i(t)&&null!==c?n(c,t):t,a=t}const d=r(a)?a.getChildren():[],h=o._nodes.get(a.getType());let m;m=h&&void 0!==h.exportDOM?h.exportDOM(o,a):a.exportDOM(o);const{element:g,after:y}=m;if(!g)return!1;const w=document.createDocumentFragment();for(let e=0;e<d.length;e++){const n=d[e],t=p(o,n,w,c);!u&&r(l)&&t&&l.extractWithChild(n,c,"html")&&(u=!0)}if(u&&!f){if(t(g)&&g.append(w),s.append(g),y){const e=y.call(a,g);e&&g.replaceWith(e)}}else s.append(w);return u}const m=new Set(["STYLE","SCRIPT"]);function g(e,n,t,l,i=new Map,f){let d=[];if(m.has(e.nodeName))return d;let h=null;const p=function(e,n){const{nodeName:t}=e,o=n._htmlConversions.get(t.toLowerCase());let l=null;if(void 0!==o)for(const n of o){const t=n(e);null!==t&&(null===l||(l.priority||0)<(t.priority||0))&&(l=t)}return null!==l?l.conversion:null}(e,n),w=p?p(e):null;let x=null;if(null!==w){x=w.after;const n=w.node;if(h=Array.isArray(n)?n[n.length-1]:n,null!==h){for(const[,e]of i)if(h=e(h,f),!h)break;h&&d.push(...Array.isArray(n)?n:[h])}null!=w.forChild&&i.set(e.nodeName,w.forChild)}const C=e.childNodes;let N=[];const b=(null==h||!s(h))&&(null!=h&&c(h)||l);for(let e=0;e<C.length;e++)N.push(...g(C[e],n,t,b,new Map(i),h));return null!=x&&(N=x(N)),o(e)&&(N=y(e,N,b?()=>{const e=new u;return t.push(e),e}:a)),null==h?d=d.concat(N):r(h)&&h.append(...N),d}function y(e,n,t){const o=e.style.textAlign,l=[];let r=[];for(let e=0;e<n.length;e++){const i=n[e];if(c(i))i.setFormat(o),l.push(i);else if(r.push(i),e===n.length-1||e<n.length-1&&c(n[e+1])){const e=t();e.setFormat(o),e.append(...r),l.push(e),r=[]}}return l}export{h as $generateHtmlFromNodes,d as $generateNodesFromDOM};
